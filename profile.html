<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Profile</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <script type = "text/javascript" src="script/inserter.js"></script>
        <script>
            if(localStorage.credentials)
                insertHTML("header-authorized.html", document.body, "afterbegin");
            else
                insertHTML("header-unauthorized.html", document.body, "afterbegin");
            insertHTML("footer.html", document.body, "beforeend");
        </script>
        <main class="wrapper">
            <h2 class="text-color-blue">Profile</h2>
            <div class="profile-info">
                <div class="editable">
                    <div class="full-name">
                        <label>
                            <h3 class="text-color-blue">First name</h3>
                            <p><input type="text" id="first_name" name="first_name"></p>
                        </label>
                        <label >
                            <h3 class="text-color-blue">Last name</h3>
                            <p><input type="text" id="last_name" name="last_name"></p>
                        </label>
                        <label>
                            <h3 class="text-color-blue">Patronymic</h3>
                            <p><input type="text" id="patronymic" name="patronymic"></p>
                        </label>
                    </div>
                </div>
                <div>
                    <h3 class="text-color-blue">Email</h3>
                    <p class="text-color-dark-grey" id="email">email@test.com<p>
                </div>
                <div class="editable">
                    <label>
                        <h3 class="text-color-blue">Phone</h3>
                        <p><input type="tel" id="phone" name="phone"></p>
                    </label>
                </div>
                <div class="editable">
                    <label>
                        <h3 class="text-color-blue">Address</h3>
                        <input type="text" id="address" name="address">
                    </label>
                </div>
                <br>
                <div id="save">
                    <button id="save-button">Save</button>
                </div>

            </div>
            <a class="text-color-blue" id="logout">Log out</a>
            <script type="module">
                import UserService from "./script/user-service.js";
                import ShoppingBasketService from "./script/shopping-basket-service.js";

                const firstNameElement = document.getElementById("first_name");
                const lastNameElement = document.getElementById("last_name");
                const patronymicElement = document.getElementById("patronymic");
                const emailElement = document.getElementById("email");
                const phoneElement = document.getElementById("phone");
                const addressElement = document.getElementById("address");

                const saveButton = document.getElementById("save-button");
                const logoutElement = document.getElementById("logout");

                UserService.getCurrent().then(userData => {
                    firstNameElement.value = userData.first_name;
                    lastNameElement.value = userData.last_name;
                    patronymicElement.value = userData.patronymic;
                    emailElement.innerHTML = userData.email;
                    phoneElement.value = userData.phone;
                    addressElement.value = userData.address;
                    console.log(userData);
                });

                saveButton.addEventListener("click", () => {
                    const userData = {
                        "first_name": firstNameElement.value,
                        "last_name": lastNameElement.value,
                        "patronymic": patronymicElement.value,
                        "phone": phoneElement.value,
                        "address": addressElement.value
                    };

                    UserService.editCurrent(userData).then(response => {
                        let resultElement = document.createElement("span");
                        resultElement.setAttribute("id", "save-result");
                        let result = null;
                        if (response.ok) {
                            resultElement.className = "text-color-blue";
                            result = "Saved";
                        }
                        else {
                            resultElement.className = "text-color-blue";
                            result = "Invalid data";
                        }
                        resultElement.innerHTML = result;
                        const saveContainer = document.getElementById("save");
                        saveContainer.appendChild(resultElement);
                        setTimeout(() => {
                            resultElement = document.getElementById("save-result");
                            resultElement.remove();
                        }, 5000);
                    });
                });

                logoutElement.addEventListener("click", () =>{
                    ShoppingBasketService.removeAll();
                    localStorage.removeItem("totalPrice");
                    localStorage.removeItem("credentials");
                    window.location.href = "index.html";
                });
                
                const placeOrderButton = document.getElementById("place-order-button");
            </script>
        </main>
    </body>
</html>