<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Shopping basket</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <script type = "text/javascript" src="script/inserter.js"></script>
        <script>
            if(localStorage.credentials)
                insertHTML("header-authorized.html", document.body, "afterbegin");
            else
                insertHTML("header-unauthorized.html", document.body, "afterbegin");
            insertHTML("footer.html", document.body, "beforeend");
        </script>
        <main class="wrapper">
            <h2 class="text-color-blue">Shopping basket</h2>
            <div class="shopping-basket" id="shopping-basket"></div>
            <div class="shopping-basket-order">
                <div class="total-price text-color-blue">
                    Total price: <span class="text-color-dark-grey">0 ₴</span>
                </div>
                <button id="place-order-button">Place an order</button>
            </div>
            <script type="module">
                import ShoppingBasketService from "./script/shopping-basket-service.js";
                import MedicationService from "./script/medication-service.js";
                const productsArray =  ShoppingBasketService.getAll();

                const shoppingBasketContainer = document.getElementById("shopping-basket");
                const orderTotalPriceElement = document.querySelector(".total-price span");
                let orderTotalPrice = 0;

                productsArray.forEach(productData => {
                    console.log(productData);
                    MedicationService.getById(productData.med_id)
                    .then(medicationData => {
                        const productTemplate = `
                        <div class="medication-order border-bottom-blue">
                            <div class="medication-order-info">
                                <div class="image vertical-align-center">
                                    <img src="img/medication.jpg" alt="edit" class="responsive-image vertical-align-center">
                                </div>
                                <div class="medication-order-name">
                                    <a href="medication.html?id=${medicationData.id}">${medicationData.name}</a>
                                </div>
                            </div>
                            <div class="medication-order-trade">
                                <input type="number" class="amount-input" id="amount" name="amount" min="1" max="${medicationData.quantity}" value="${productData.amount}">
                                <div class="medication-order-price">${productData.amount * medicationData.cost} ₴</div>
                                <button class="remove-button">Remove</button>
                            </div>
                        </div>`
                        shoppingBasketContainer.insertAdjacentHTML("beforeend", productTemplate);
                        const currentElement = shoppingBasketContainer.lastElementChild;
                        const amountInput = currentElement.getElementsByClassName("amount-input")[0];
                        const productPriceElement = currentElement.getElementsByClassName("medication-order-price")[0];
                        
                        amountInput.onchange = () => {
                            orderTotalPrice = 0;
                            productData.amount = amountInput.value;
                            const changeIndex = productsArray.map(item => item.med_id).indexOf(productData.med_id); 
                            productsArray[changeIndex].amount = parseInt(amountInput.value);
                            localStorage.setItem("products", JSON.stringify(productsArray));
                            const productTotalPrice = amountInput.value * medicationData.cost;
                            productPriceElement.innerHTML = `${productTotalPrice} ₴`;
                            const productElementsArray = shoppingBasketContainer.getElementsByClassName("medication-order-price");
                            Array.from(productElementsArray).forEach(productElement => {
                                orderTotalPrice += parseInt(productElement.textContent.split(" ")[0]);
                            });
                            orderTotalPriceElement.innerHTML = `${orderTotalPrice} ₴`;
                        }

                        const removeButton = currentElement.getElementsByClassName("remove-button")[0];
                        removeButton.addEventListener("click", () => {
                            ShoppingBasketService.removeProduct(productData.med_id);
                            currentElement.remove();
                            if (!ShoppingBasketService.getAll().length)
                            {
                                orderTotalPrice = 0;
                                orderTotalPriceElement.innerHTML = `${orderTotalPrice} ₴`;
                            }
                        });

                        const productElementsArray = shoppingBasketContainer.getElementsByClassName("medication-order-price");
                        Array.from(productElementsArray).forEach(productElement => {
                            orderTotalPrice += parseInt(productElement.textContent.split(" ")[0]);
                        });
                        console.log(orderTotalPrice);
                        orderTotalPriceElement.innerHTML = `${orderTotalPrice} ₴`;
                    });
                
                });



                const placeOrderButton = document.getElementById("place-order-button");
                placeOrderButton.addEventListener("click", () => {
                    if (!localStorage.getItem("credentials"))
                        window.location.href = "sign-in.html";
                    else
                        window.location.href = "order.html";
                });
            </script>
        </main>
    </body>
</html>